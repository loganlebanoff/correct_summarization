<link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

<section class="col-12 my-4" id="examples" style="display: none;">
    <div class="card border-info">
        <div class="card-header bg-info text-white text-center">
            <h5 class="m-0">Examples</h5>
        </div>
        <div class="card-body row border-between">
            <div id="divExampleLeft" class="col-12 col-md-6">

            </div>
            <div id="divExampleRight" class="col-12 col-md-6">

            </div>
        </div>
    </div>
</section>

<!-- Instructions -->
<section class="col-12 my-4" id="instructions">
    <div>
        <button class="btn btn-info btn-block btn-lg text-white text-center" type="button"
            data-toggle="collapse" data-target="#instructionCollapse"
            aria-expanded="false" aria-controls="instructionCollapse">
            <h5 class="m-0">Instructions</h5>
        </button>
        <div class="collapse mt-3" id="instructionCollapse">
            <div class="card">
                <div class="row card-body">
                    <!-- Actual Instructions -->
                    <div class="col-12 col-md-6" id="actualInstructions">
                        <p class="d-block col-12 text-center"><em>Firstly,
                            thanks for participating in our study!</em></p>
                        <p><strong>Description: </strong> We have machine-generated (AI)
                            summary sentences of an Article. Each summary sentence pulls from 2 article
                            sentences to create the result you see.</p>

                        <p class="mb-0"><strong>What we need <em>you</em> to do:</strong></p>
                        <ol>
                            <li class="list-item">
                                <strong>Read the entire article.</strong> (It
                                should be a pretty quick read.)
                            </li>
                            <li class="list-item">
                                Go through each of the <a href="#summaries">Summary Sentences</a>,
                                hover over each to highlight the corresponding
                                sentences in the article. Click on the summary sentence to keep the sentences highlighted.
                                <strong>Read each summary sentence
                                and answer the following questions:</strong>
                                <ol>
                                    <li class="list-item">
                                        <strong>Faithful:</strong> Does the summary sentence convey the same meaning as the original article?
                                    </li>
                                    <li class="list-item">
                                        <strong>Coverage:</strong> Does the highlighted text contain all information used to generate the summary sentence?
                                    </li>
                                    <li class="list-item">
                                        <strong>Grammatical:</strong> Is this sentence grammatically correct?
                                    </li>
                                    <li class="list-item">
                                        <strong>Merging:</strong> How is the summary sentence created?
                                        <ul type="a">
                                            <li class="list-item">
                                                <i>Replacement:</i> a pronoun or description of an entity in one sentence is replaced by a different description
                                                of that entity in the other sentence.
                                            </li>
                                            <li class="list-item">
                                                <i>Balanced Concatenation:</i> a consecutive part of one sentence is concatenated (linked together side-by-side)
                                                with a consecutive part of the other sentence. The parts taken from each sentence are of similar length.
                                            </li>
                                            <li class="list-item">
                                                <i>Imbalanced Concatenation:</i> similar to "Balanced Concatenation,"
                                                but the part taken from one sentence is larger than the part taken from the other sentence.
                                            </li>
                                            <li class="list-item">
                                                <i>Other:</i> all remaining cases.
                                            </li>
                                        </ul>
                                    </li>
                                </ol>
                            </li>
                        </ol>
                    </div>

                    <!-- Examples -->
                    <div class="col-12 col-md-6" id="examples">
                        <p class="d-block col-12 text-center"><em>Examples</em></p>
                        <div class="accordian" id="allExamples">
                            <!-- Example -->
                            <div class="card">
                                <div class="card-header p-0" id="example1">
                                    <button class="btn btn-block btn-lg btn-link collapsed" type="button"
                                        data-toggle="collapse" data-target="#example1body"
                                        aria-expanded="true" aria-controls="example1body">
                                        Example 1 (Collapsable)
                                    </button>
                                </div>
                                <div id="example1body" class="collapse show" aria-labelledby="example1" data-parent="#allExamples">
                                    <div class="card-body">
                                        Example 1 content
                                    </div>
                                </div>
                            </div>
                            <!-- /Example -->
                            <!-- Example -->
                            <div class="card">
                                <div class="card-header p-0" id="example2">
                                    <button class="btn btn-block btn-lg btn-link collapsed" type="button"
                                        data-toggle="collapse" data-target="#example2body"
                                        aria-expanded="true" aria-controls="example2body">
                                        Example 2 (Collapsable)
                                    </button>
                                </div>
                                <div id="example2body" class="collapse" aria-labelledby="example2" data-parent="#allExamples">
                                    <div class="card-body">
                                        Example 2 content
                                    </div>
                                </div>
                            </div>
                            <!-- /Example -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- /Instructions -->


<script>
    function putArticle(articleSents) {
        let article = document.getElementById("src-article-content");
        let idx = 0;
        articleSents.split("||").forEach(function (sent) {
            let p = document.createElement("p");
            p.id = "sent" + idx;
            p.innerHTML = sent;
            p.setAttribute("class", "alert py-1 px-2");
            article.appendChild(p);
            idx++;
        })
    }

    let   usedColors = new Set();
    const fromColors = [
        "#8dd3c7", "#ffffb3", "#bebada", "#fb8072",
        "#80b1d3", "#fdb462", "#b3de69", "#fccde5",
        "#d9d9d9", "#bc80bd", "#ccebc5", "#ffed6f",
    ];

    function addQuestion(text) {
        let wrapper = document.createElement("div");
        wrapper.setAttribute("class", "mb-3 col-4");

        let keyword = document.createElement("div");
        keyword.setAttribute("class", "p-0 m-0 col-12 text-center");

        let keyword_txt = document.createElement("em");
        keyword_txt.setAttribute("class", "mx-0 my-auto");
        keyword_txt.innerHTML = text;
        keyword.appendChild(keyword_txt);

        wrapper.appendChild(keyword);

        return wrapper;
    }

    function addYNQuestion(id, text, name) {
        let wrapper = addQuestion(text);

        let choices = document.createElement("div");
        choices.setAttribute("class", "p-0 m-0 btn-group-vertical d-flex");

        choices.appendChild(addQsButton("YES", "btn-success", id, name));
        choices.appendChild(addQsButton("NO" , "btn-danger" , id, name));

        wrapper.appendChild(choices);

        return wrapper;
    }

    function addQsButton(text, color, id, name) {
        let x = document.createElement("label");
        x.setAttribute("class", "my-auto btn btn-block btn-sm " + color);
        let input_id = text + "_" + id + "_" + name
        x.setAttribute("for", input_id);
        x.innerHTML = text + "<input type='radio' id='" + input_id + "' name='" + name + "'>";

        return x;
    }

    function addMultiQuest(id, text, name) {
        let wrapper = addQuestion(text);
        wrapper.setAttribute("class", "mb-3 col-12");

        let choices = document.createElement("div");
        choices.setAttribute("class", "p-0 m-0 btn-group d-flex");

        choices.appendChild(addQsButton("Replacement"   , "btn-primary"  , id, name));
        choices.appendChild(addQsButton("Bal. Concat."  , "btn-secondary", id, name));
        choices.appendChild(addQsButton("Imbal. Concat.", "btn-info"     , id, name));
        choices.appendChild(addQsButton("Other"         , "btn-warning"  , id, name));

        wrapper.appendChild(choices);

        return wrapper;
    }

    function newColor() {
        let rand = null, color = null;
        do {
            sleep(20);
            rand = Math.floor(Math.random() * fromColors.length);
            color = fromColors[rand];
        } while (usedColors.has(color));
        usedColors.add(color);

        if (usedColors.size === fromColors.length)
            usedColors = new Set();

        return fromColors[rand];
    }

    function setBG(el, bg=el.style.backgroundColor) {
        if (!el.hasAttribute("data-srcs"))
            return

        let srcs = el.getAttribute("data-srcs").split(",");
        if (parseInt(srcs) !== -1) {
            srcs.forEach(function (id) {
                document.getElementById("sent" + id).style.backgroundColor = bg;
            })
        }
    }

    function addSummary(idx, meta) {
        let tasks = document.getElementById("tasks");

        let card = document.createElement("div");
        card.setAttribute("class", "alert summary-sent px-2 py-1 pb-2 my-2");

        card.style.backgroundColor = newColor();
        card.id = "summary" + idx;
        card.setAttribute("data-srcs", meta.src);

        let summary = document.createElement("strong");
        summary.setAttribute("class", "mb-1");
        summary.innerHTML = meta.sum;

        card.appendChild(summary);

        let hr = document.createElement("hr");
        hr.setAttribute("class", "my-2");
        card.appendChild(hr);

        let row = document.createElement("div");
        row.setAttribute("class", "row m-0");
        row.appendChild(addMultiQuest(idx, "Merging",             ("Merging_" + idx)));
        row.appendChild(addYNQuestion(idx, "Faithfulness",        ("Faithfulness_" + idx)));
        row.appendChild(addYNQuestion(idx, "Grammatical",         ("Grammatical_" + idx)));
        row.appendChild(addYNQuestion(idx, "Incomplete Coverage", ("IncompleteCoverage_" + idx)));

        card.appendChild(row);

        let src_id = document.createElement("input");
        src_id.setAttribute("type", "hidden");
        src_id.setAttribute("value", meta.sys);
        card.appendChild(src_id)

        tasks.appendChild(card);
        card.setAttribute("data-clicked", false);

        card.addEventListener("mouseenter", function () {
            setBG(card);
        })

        card.addEventListener("mouseleave", function () {
            if (!card.getAttribute("data-clicked"))
                setBG(card, "#fff");
        })

        card.addEventListener("click", function () {
            let tasks = document.getElementById("tasks");
            Array.prototype.forEach.call(tasks.children, function (el) {
                setBG(el, "#fff");
            })

            setBG(card);
            card.setAttribute("data-clicked", true);
        })
    }

    function zip2(srcs, summs) {
        return srcs.map(function (el, idx) {
            return [srcs[idx], summs[idx]];
        })
    }

    function zip3(srcs, summs, syss) {
        return srcs.map(function (el, idx) {
            return [srcs[idx], summs[idx], syss[idx]];
        })
    }

    function shuffle(arr) {
        let c_idx = arr.length;
        let t_val, r_idx;

        while (c_idx !== 0) {
            r_idx = Math.floor(Math.random() * c_idx);
            c_idx -= 1;

            t_val = arr[c_idx];
            arr[c_idx] = arr[r_idx];
            arr[r_idx] = t_val;
        }

        return arr;
    }

    function parseSummaries(meta) {
        let summaries = [];
        meta.forEach(function (el, idx) {
            summaries.push({
                "src": el[0].split("||"),
                "sum": el[1],
                "sys": el[2],
            })
        });

        shuffle(summaries);

        return summaries;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
</script>


<!-- Tasks -->
<section id="tasks-to-complete">
    <div class="row mx-0">
        <div class="col-12 col-md-6" id="src-article">
            <div class="card border-secondary">
                <div class="card-header bg-secondary d-flex justify-content-between">
                    <p class="text-light text-center d-flex m-auto"> <strong>Article</strong> </p>
                    <button type="button" id="clear-highlights" class="btn btn-warning">Clear Highlights</button>
                </div>
                <div class="card-body p-2" id="src-article-content"></div>
            </div>
        </div>
        <div class="col-12 col-md-6" id="summaries">
            <div class="card">
                <div class="card-header bg-light text-center"><strong>Summary Sentences</strong></div>
                <div class="card-body p-2">
                    <fieldset id="tasks">
                        <input type="hidden" name="${article_id}">
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
    <script>
        // let article_id = "c646bd9c55607b1c13e3b828345efa8128e58847dd4412244dd5c45ba8644f23";
        // let article_content = "(CNN) Michele Bachmann is comparing President Obama to the co-pilot of the doomed Germanwings flight.||&quot;With his Iran deal, Barack Obama is for the 300 million souls of the United States what Andreas Lubitz was for the 150 souls on the German Wings flight - a deranged pilot flying his entire nation into the rocks,&quot; the Minnesota Republican and former representative wrote in a Facebook comment posted March 31.||&quot;After the fact, among the smoldering remains of American cities, the shocked survivors will ask, why did he do it?&quot;||Andreas Lubitz, the co-pilot of Germanwings Flight 9525, is accused by authorities of deliberately crashing the plane in the French Alps.||He died in the crash along with 149 other crew and passengers.||The motive of the March 24 crash is under investigation, though investigators are looking in to whether Lubitz feared a medical condition would cause him to lose his pilot&apos;s license.||Many comments posted on her Facebook page blasted the former representative.||Melissa Coca wrote, &quot;Comparing this tragedy to anything is moronic and despicable.&quot;||Michael J Pristash wrote, &quot;Your allusion is so inappropriate and divisive, not to mention disrespectful on so many levels.||Shame on you.&quot;||Some also accused her of taking desperate measures to stay in the public eye.||Lynda Anderson wrote, &quot;Posting outrageous things in a pathetic attempt to stay relevant?&quot;||Negotiations are coming down to the wire between Iran, the United States and other nations on restricting Tehran&apos;s nuclear program to prevent the ability to develop an atomic bomb.||One deadline passed Tuesday, but there is a June 30 deadline for a comprehensive deal -- with all technical and diplomatic impasses fully worked out.||Bachmann is no stranger to voicing her opinion on the President&apos;s dealing with Iran, personally telling him to &quot;bomb Iran&quot; during the 2014 White House Christmas Party.||&quot;I turned to the president and I said, something to the effect of,&apos;Mr. President, you need to bomb the Iranian nuclear facilities, because if you do n&apos;t, Iran will have a nuclear weapon on your watch and the course of world history will change,&apos;&quot; she told the Washington Free Beacon.||The congresswoman, who sought the GOP presidential nomination in 2012, said Obama had a &quot;condescending smile on his face and laughed at me.&quot;||She said he told her: &quot;Well Michele, it&apos;s just not that easy.&quot;";
        // let sources_0 = "3,4";
        // let sources_1 = "2,1";
        // let sources_2 = "1,2";
        // let sources_3 = "3,4";
        // let sources_4 = "0,6";
        // let sources_5 = "1,0";
        // let summary_0 = "barker&apos;s &quot;lucky seven&quot; game show for 35 years.";
        // let summary_1 = "contestants told to &quot;come on down!&quot; on the april 1 edition of &quot;the price is right&quot; encountered not host drew carey.";
        // let summary_2 = "the price is in a price is right, &quot; contestants told to &quot; come on.";
        // let summary_3 = "bob barker was the first price-guessing game of the show for 35 years before stepping down in 2007.";
        // let summary_4 = "former gop representative compares president obama to andreas lubitz.";
        // let summary_5 = "contestants told to &quot;come on down!&quot; for the first time in eight years.";
        // let system_0 = "bottom-up";
        // let system_1 = "pg";
        // let system_2 = "dca";
        // let system_3 = "novel";
        // let system_4 = "reference";
        // let system_5 = "bottom-up";

        let sourceArticle = `${article_content}`;
        putArticle(sourceArticle);

        let summary_meta = [
            [`${sources_0}`, `${summary_0}`, `${system_0}`],
            [`${sources_1}`, `${summary_1}`, `${system_1}`],
            [`${sources_2}`, `${summary_2}`, `${system_2}`],
            [`${sources_3}`, `${summary_3}`, `${system_3}`],
            [`${sources_4}`, `${summary_4}`, `${system_4}`],
            [`${sources_5}`, `${summary_5}`, `${system_5}`],
        ];

        let summaries = parseSummaries(summary_meta);

        let idx = 0;
        console.log(summaries);
        summaries.forEach(function (meta) {
            addSummary(idx,  meta);
            idx++;
        });

        document.getElementById("clear-highlights").addEventListener("click", function() {
            let tasks = document.getElementById("tasks");
            Array.prototype.forEach.call(tasks.children, function(el) {
                setBG(el, "#fff");
                el.setAttribute("data-clicked", false);
            })
        })
    </script>
</section>

<style>
    p[id^="sent"] {
        transition: background-color 200ms ease-in-out;
        /*border-color: rgba(25, 25, 25, 0.25);*/
        margin-bottom: 0.25em;
        -webkit-border-radius: 0;
        -moz-border-radius: 0;
        border-radius: 0.25em;
        /*padding: 0.25em 0.5em;*/
    }

    div.summary-sent > div:last-child {
        margin: 0 !important;
    }

    div.card-header {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 10000000;
    }
</style>
<!-- /Tasks -->
